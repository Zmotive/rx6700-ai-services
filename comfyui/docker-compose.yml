services:
  comfyui:
    image: rocm/pytorch:rocm6.4.4_ubuntu22.04_py3.10_pytorch_release_2.6.0
    container_name: comfyui
    hostname: comfyui
    restart: unless-stopped
    
    ports:
      - "8188:8188"
    
    volumes:
      - ./start.sh:/start.sh
      - ./patch_rocm.sh:/patch_rocm.sh
      - comfyui-data:/workspace
      - ~/.cache/huggingface:/root/.cache/huggingface
    
    working_dir: /workspace
    
    devices:
      - /dev/kfd
      - /dev/dri
    
    group_add:
      - "44"    # video group
      - "109"   # render group
    
    environment:
      - HSA_OVERRIDE_GFX_VERSION=10.3.0
      - PYTORCH_ROCM_ARCH=gfx1031
      - HIP_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
      - COMFYUI_PORT=8188
    
    command: bash /start.sh
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188/system_stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  comfyui-data:
